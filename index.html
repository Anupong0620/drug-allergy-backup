<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ตรวจสอบประวัติแพ้ยา (ใส่รหัสก่อนเข้า)</title>
  <style>
    :root{--bg:#0b1220;--ink:#e5e7eb;--muted:#94a3b8;--line:#223;--card:#0f172a;--accent:#22d3ee;--err:#ef4444;--ok:#16a34a}
    html,body{height:100%}
    body { font-family: system-ui, sans-serif; background: radial-gradient(1200px 600px at 10% -10%, #0d1b2a 20%, transparent 60%), radial-gradient(1200px 600px at 110% 0%, #0a1628 15%, transparent 60%), var(--bg); color: var(--ink); margin: 0; padding: 20px; }
    .container { max-width: 980px; margin: auto; display: none; }
    input, button { padding: 10px; margin: 5px 0; border-radius: 10px; border: 1px solid var(--line); background:#0d1628; color:#e5e7eb }
    button { cursor: pointer }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .toolbar .grow{ flex: 1 1 280px }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border-bottom: 1px solid #333; }
    th { background: #0f172a; position: sticky; top: 0; text-align:left }
    tr:hover { background: #111827; }
    .meta { margin-top: 8px; font-size: 12px; color: var(--muted); display:flex; gap:16px; flex-wrap:wrap; align-items:center }
    .badge{background:#0b1120;border:1px solid #233;padding:2px 8px;border-radius:999px}
    .credit{font-size:12px;color:var(--muted);margin-top:12px}
    .center{text-align:center}

    /* --- LOGIN --- */
    .login-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10}
    .login-card{width:min(460px,92vw);background:linear-gradient(180deg,#0f172a,#0b1323);border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 50px rgba(0,0,0,.45);border-radius:18px;padding:22px}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 210deg, #22d3ee, #8b5cf6);display:grid;place-items:center;color:#021024;font-weight:800}
    .logo-img{width:42px;height:42px;border-radius:12px;object-fit:contain;background:#0b1220;border:1px solid rgba(255,255,255,.08)}
    .brand .title{font-weight:700;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px}
    .field{position:relative}
    .field input{width:100%;padding-right:44px}
    .toggle-eye{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:transparent;border:1px solid transparent;padding:6px;border-radius:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .err{color:var(--err);font-size:12px;min-height:16px;margin-top:6px}
    .actions{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .remember{display:flex;align-items:center;gap:8px;font-size:13px;color:#cbd5e1}
    .btn-primary{background:#1f2937}
    .login-card.shake{animation:shake .28s linear}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

    /* brand in app header */
    .brand-app{display:flex;align-items:center;gap:10px}
    .logo-img.small{width:28px;height:28px;border-radius:8px}
  </style>
</head>
<body>
<!-- LOGIN -->
<div id="login" class="login-wrap">
  <div class="login-card" id="loginCard">
    <div class="brand">
      <!-- Image logo (hidden by default until configured) -->
      <img id="brandLogo" class="logo-img" alt="Hospital logo" style="display:none"/>
      <!-- Fallback badge -->
      <div id="logoFallback" class="logo">RX</div>
      <div class="title" id="brandTitle">เข้าสู่ระบบ</div>
    </div>
    <div class="sub">ป้อนรหัส 5 หลักที่ได้รับจากผู้ดูแล เพื่อเข้าใช้งานเครื่องมือตรวจสอบประวัติแพ้ยา</div>

    <div class="field">
      <input type="password" id="passcode" placeholder="เช่น 11251" inputmode="numeric" autocomplete="one-time-code" autofocus>
      <button id="togglePass" class="toggle-eye" type="button" aria-label="แสดง/ซ่อนรหัส">
        <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z" stroke="#9ca3af"/><circle cx="12" cy="12" r="3" fill="#9ca3af"/></svg>
      </button>
    </div>
    <div class="actions">
      <label class="remember"><input type="checkbox" id="rememberMe"> จำอุปกรณ์นี้</label>
      <button id="loginBtn" type="button" class="btn-primary">เข้าสู่ระบบ</button>
    </div>
    <div id="loginMsg" class="err"></div>
    <div class="hint">กด Enter เพื่อยืนยัน • อุปกรณ์สาธารณะ: ไม่ควรติ๊ก "จำอุปกรณ์นี้"</div>
    <div class="hint" id="lastLoginInfo"></div>
    <div class="hint" style="margin-top:8px">จัดทำโดย <b>ฝ่ายเภสัชกรรมและคุ้มครองผู้บริโภค โรงพยาบาลชาติตระการ</b></div>
  </div>
</div>

<!-- APP -->
<div class="container" id="app">
  <div class="brand-app" style="margin-bottom:6px">
    <img id="brandLogoApp" class="logo-img small" alt="Hospital logo" style="display:none"/>
    <h1 id="appTitle" style="margin:0">ตรวจสอบประวัติแพ้ยา</h1>
  </div>
  <div class="toolbar">
    <input class="grow" type="text" id="q" placeholder="ค้นหาชื่อหรือ HN">
    <input type="file" id="fileInput" accept=".csv,.tsv,.txt,.json,.xls,.xlsx">
    <button id="btnExport" title="บันทึกข้อมูลที่กำลังแสดงเป็นไฟล์ JSON">บันทึก JSON</button>
    <button id="btnLogout" title="ออกจากระบบ">ออกจากระบบ</button>
  </div>
  <div class="meta">
    <div>แหล่งข้อมูล: <span id="source">—</span></div>
    <div>อัปเดตล่าสุด: <span id="lastUpload">—</span></div>
    <div>ไฟล์: <span id="fileName">—</span></div>
    <div>รายการ: <span id="rowCount" class="badge">0</span></div>
  </div>

  <table>
    <thead>
      <tr><th>ชื่อ</th><th>HN</th><th>ยา</th><th>อาการ</th><th>วันที่รายงาน</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <details class="tests">
    <summary>Dev: run built‑in tests</summary>
    <pre id="testResults" style="white-space:pre-wrap;color:#9aa4b2">ยังไม่ได้รัน</pre>
  </details>
  <div class="credit center">จัดทำโดย <b>ฝ่ายเภสัชกรรมและคุ้มครองผู้บริโภค โรงพยาบาลชาติตระการ</b></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
// ===== Config =====
const PASSCODE = "11251";       // รหัสก่อนเข้าใช้
const MAX_TRIES = 5;             // ใส่ผิดได้กี่ครั้ง
const LOCK_MS   = 15000;         // ล็อกกี่มิลลิวินาทีเมื่อผิดครบ
// >>> ตั้งค่ารูปโลโก้และชื่อ รพ. ที่นี่ <<<
const BRAND = {
  name: 'โรงพยาบาลชาติตระการ',           // ชื่อโรงพยาบาล
  logoSrc: './logo.png',                   // ไฟล์โลโก้อยู่ที่ root
  showOnAppHeader: true                    // แสดงโลโก้/ชื่อบนหัวแอป
};

// ===== Elements =====
const els = {
  login: document.getElementById('login'),
  loginCard: document.getElementById('loginCard'),
  pass: document.getElementById('passcode'),
  btnLogin: document.getElementById('loginBtn'),
  btnToggle: document.getElementById('togglePass'),
  eyeIcon: document.getElementById('eyeIcon'),
  msg: document.getElementById('loginMsg'),
  remember: document.getElementById('rememberMe'),
  lastLoginInfo: document.getElementById('lastLoginInfo'),
  brandLogo: document.getElementById('brandLogo'),
  logoFallback: document.getElementById('logoFallback'),
  brandTitle: document.getElementById('brandTitle'),

  app: document.getElementById('app'),
  appTitle: document.getElementById('appTitle'),
  brandLogoApp: document.getElementById('brandLogoApp'),
  q: document.getElementById('q'),
  rows: document.getElementById('rows'),
  file: document.getElementById('fileInput'),
  btnExport: document.getElementById('btnExport'),
  btnLogout: document.getElementById('btnLogout'),
  lastUpload: document.getElementById('lastUpload'),
  fileName: document.getElementById('fileName'),
  rowCount: document.getElementById('rowCount'),
  source: document.getElementById('source'),
  tests: document.getElementById('testResults'),
};

// ===== Brand setup =====
(function setupBrand(){
  try {
    if (BRAND && BRAND.name) {
      els.brandTitle.textContent = BRAND.name + ' • เข้าสู่ระบบ';
      if (BRAND.showOnAppHeader) {
        els.appTitle.textContent = (BRAND.name + ' • ตรวจสอบประวัติแพ้ยา');
      }
    }
    if (BRAND && BRAND.logoSrc) {
      els.brandLogo.src = BRAND.logoSrc; els.brandLogo.style.display = 'block';
      els.logoFallback.style.display = 'none';
      if (BRAND.showOnAppHeader) {
        els.brandLogoApp.src = BRAND.logoSrc; els.brandLogoApp.style.display = 'block';
      }
    }
  } catch {}
})();

// ===== State & Cache =====
let DATA = [];
const LS_DATA = 'rx_allergy_data_v1';
const LS_UPDATED = 'rx_allergy_updated_v1';
const LS_NAME = 'rx_allergy_filename_v1';
const LS_SOURCE = 'rx_allergy_source_v1';
const LS_LAST_LOGIN = 'rx_last_login';
const LS_GATE_PERM = 'rx_gate_ok_perm';
let tries = 0; let lockUntil = 0; let lockTimer = null;

function fmtTH(iso){ try{ return new Date(iso).toLocaleString('th-TH'); }catch{ return '—'; } }
function setMeta({updated,name,source}){
  if(updated){ localStorage.setItem(LS_UPDATED, updated); }
  if(name){ localStorage.setItem(LS_NAME, name); }
  if(source){ localStorage.setItem(LS_SOURCE, source); }
  els.lastUpload.textContent = fmtTH(localStorage.getItem(LS_UPDATED) || updated || '');
  els.fileName.textContent = localStorage.getItem(LS_NAME) || name || '—';
  els.source.textContent = localStorage.getItem(LS_SOURCE) || source || '—';
}
function saveCache(){ localStorage.setItem(LS_DATA, JSON.stringify(DATA)); setMeta({updated:new Date().toISOString()}); }
function loadCache(){ try{ const raw=localStorage.getItem(LS_DATA); if(raw){ DATA = JSON.parse(raw)||[]; } }catch{} setMeta({}); render(DATA); }

// ===== Auth =====
function normalizeDigits(s){ if(!s) return ''; const map={'๐':'0','๑':'1','๒':'2','๓':'3','๔':'4','๕':'5','๖':'6','๗':'7','๘':'8','๙':'9'}; return s.replace(/[๐-๙]/g,ch=>map[ch]||ch); }
function isLocked(){ return Date.now() < lockUntil; }
function updateLockMsg(){ if(!isLocked()){ els.msg.textContent=''; return; } const left = Math.max(0, Math.ceil((lockUntil - Date.now())/1000)); els.msg.textContent = `ใส่รหัสผิดหลายครั้ง กรุณารอ ${left}s`; if(left<=0){ clearInterval(lockTimer); lockTimer=null; els.msg.textContent=''; } }
function showApp(){ els.login.style.display='none'; els.app.style.display='block'; }
function setLoggedIn(persistent){ if(persistent) localStorage.setItem(LS_GATE_PERM,'1'); else sessionStorage.setItem('rx_gate_ok','1'); localStorage.setItem(LS_LAST_LOGIN, new Date().toISOString()); showApp(); }
function tryLogin(){ if(isLocked()) return; const code = normalizeDigits((els.pass.value||'').trim()); if(code===PASSCODE){ setLoggedIn(els.remember.checked); } else { tries++; els.msg.textContent='รหัสไม่ถูกต้อง'; els.loginCard.classList.remove('shake'); void els.loginCard.offsetWidth; els.loginCard.classList.add('shake'); if(tries>=MAX_TRIES){ lockUntil = Date.now()+LOCK_MS; updateLockMsg(); lockTimer = setInterval(updateLockMsg, 500); tries=0; } els.pass.focus(); els.pass.select?.(); } }
els.btnLogin.addEventListener('click', tryLogin);
els.pass.addEventListener('keydown', e=>{ if(e.key==='Enter') tryLogin(); });
els.btnToggle.addEventListener('click', ()=>{ const show = els.pass.type==='password'; els.pass.type = show? 'text':'password'; els.eyeIcon.innerHTML = show ? '<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z" stroke="#9ca3af"/><circle cx="12" cy="12" r="3" fill="#9ca3af"/>' : '<path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.8 21.8 0 0 1 5.06-5.94M9.9 4.24A10.94 10.94 0 0 1 12 5c7 0 11 7 11 7a21.8 21.8 0 0 1-3.17 3.95M1 1l22 22" stroke="#9ca3af"/>'; });
(function(){ const last = localStorage.getItem(LS_LAST_LOGIN); if(last){ els.lastLoginInfo.textContent = 'เข้าสู่ระบบล่าสุด: '+ fmtTH(last); } })();

// ===== File/Repo Loaders =====
function splitCSVLine(line, delim){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; } else if(ch===delim && !inQ){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out.map(s=>s.trim()); }
function parseCSV(text, delim=','){ const lines = text.replace(/\r\n?/g,'\n').split('\n'); if(!lines.length) return []; const headers = splitCSVLine(lines.shift()||'', delim); const out=[]; for(const line of lines){ if(!line.trim()) continue; const vals = splitCSVLine(line, delim); const o={}; headers.forEach((h,i)=>o[h]=vals[i]??''); out.push(o);} return out; }
function normalizeRow(obj){ const m={}; for(const k of Object.keys(obj||{})){ m[k.trim().toLowerCase()]=obj[k]; } return { name:m['name']??m['ชื่อ']??'', hn:String(m['hn']??m['h.n']??m['รหัส']??'').trim(), agent:m['agent']??m['ยา']??m['ยาที่แพ้']??'', symptom:m['symptom']??m['อาการ']??'', report_date:m['report_date']??m['date']??m['วันที่']??'', }; }
async function readTextSmart(file){ const buf=await file.arrayBuffer(); try{ return new TextDecoder('utf-8',{fatal:true}).decode(new Uint8Array(buf)); }catch{} try{ return new TextDecoder('windows-874').decode(new Uint8Array(buf)); }catch{} return new TextDecoder().decode(new Uint8Array(buf)); }
async function handleFile(file){ const name=file.name; const ext=name.split('.').pop().toLowerCase(); try{ if(ext==='json'){ const txt=await readTextSmart(file); const arr=JSON.parse(txt); DATA=(Array.isArray(arr)?arr:[]).map(normalizeRow); } else if(ext==='csv' || ext==='tsv' || ext==='txt'){ const txt=await readTextSmart(file); const delim=(ext==='tsv'||txt.includes('\t'))?'\t':','; DATA=parseCSV(txt,delim).map(normalizeRow); } else if(ext==='xls' || ext==='xlsx'){ const wb=await new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=e=>{ try{ resolve(XLSX.read(e.target.result,{type:'binary'})); }catch(err){ reject(err); } }; r.onerror=reject; r.readAsBinaryString(file); }); const ws=wb.Sheets[wb.SheetNames[0]]; DATA=XLSX.utils.sheet_to_json(ws).map(normalizeRow);} else { alert('ชนิดไฟล์ไม่รองรับ'); return; } render(DATA); setMeta({updated:new Date().toISOString(), name, source:'อัปโหลดไฟล์'}); saveCache(); }catch(err){ console.error(err); alert('อ่านไฟล์ไม่สำเร็จ'); } }
els.file.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); e.target.value=''; });

async function loadFromRepo(){ try{ const r=await fetch('./allergy.json',{cache:'no-store'}); if(!r.ok) throw 0; const arr=await r.json(); DATA=(Array.isArray(arr)?arr:[]).map(normalizeRow); render(DATA); setMeta({updated:new Date().toISOString(), name:'allergy.json', source:'repo'}); saveCache(); return; }catch{} try{ const ym=new Date().toISOString().slice(0,7); const r2=await fetch(`./archive/allergy-${ym}.json`,{cache:'no-store'}); if(!r2.ok) throw 0; const arr2=await r2.json(); DATA=(Array.isArray(arr2)?arr2:[]).map(normalizeRow); render(DATA); setMeta({updated:new Date().toISOString(), name:`archive/allergy-${ym}.json`, source:'repo'}); saveCache(); return; }catch{} if(!DATA.length){ loadCache(); } }

// ===== Render & Search =====
function fmtDate(d){ if(!d) return '—'; try{ const dt=new Date(d); if(!isNaN(dt)) return dt.toLocaleDateString('th-TH'); }catch{} return String(d); }
function render(arr){ els.rows.innerHTML = (arr||[]).map(r=>`<tr><td>${escapeHtml(r.name||'')}</td><td>${escapeHtml(r.hn||'')}</td><td>${escapeHtml(r.agent||'')}</td><td>${escapeHtml(r.symptom||'')}</td><td>${escapeHtml(fmtDate(r.report_date))}</td></tr>`).join(''); els.rowCount.textContent = String((arr||[]).length); }
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function onSearch(){ const v=(els.q.value||'').trim().toLowerCase(); if(!v){ render(DATA); return; } const isNum=/^\d+$/.test(v); const out=DATA.filter(r=> isNum ? String(r.hn||'').toLowerCase().includes(v) : String(r.name||'').toLowerCase().includes(v)); render(out); }
els.q.addEventListener('input',()=>{ clearTimeout(window._t); window._t=setTimeout(onSearch,120); });

// ===== Export / Logout =====
function exportJSON(){ if(!Array.isArray(DATA)||DATA.length===0){ alert('ยังไม่มีข้อมูลให้บันทึก'); return; } const pretty=JSON.stringify(DATA,null,2); const blob=new Blob([pretty],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const ts=new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]; a.href=url; a.download=`allergy-${ts}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
els.btnExport.addEventListener('click', exportJSON);
els.btnLogout.addEventListener('click', ()=>{ sessionStorage.removeItem('rx_gate_ok'); localStorage.removeItem(LS_GATE_PERM); location.reload(); });

// ===== Tests =====
function runTests(){ const out=[]; const ok=(n)=>out.push('✅ '+n); const ng=(n,m)=>out.push('❌ '+n+' → '+m); try{ normalizeDigits('๑๑๒๕๑')==='11251'?ok('thai digits'):ng('thai digits','map failed'); }catch(e){ ng('thai digits',e.message); } try{ const l=splitCSVLine('"a,b",c',','); (l.length===2&&l[0]==='a,b'&&l[1]==='c')?ok('csv quotes'):ng('csv quotes',JSON.stringify(l)); }catch(e){ ng('csv quotes',e.message); } try{ const arr=parseCSV('name,hn\nสมชาย,123',','); (arr[0].name==='สมชาย'&&arr[0].hn==='123')?ok('parse csv'):ng('parse csv',JSON.stringify(arr)); }catch(e){ ng('parse csv',e.message); } els.tests.textContent = out.join('\n'); els.tests.className = out.some(x=>x.startsWith('❌')) ? 'test-fail' : 'test-pass'; }

// ===== Init =====
(function init(){ if(sessionStorage.getItem('rx_gate_ok')==='1' || localStorage.getItem(LS_GATE_PERM)==='1'){ showApp(); } else { els.pass.focus(); const last = localStorage.getItem(LS_LAST_LOGIN); if(last){ els.lastLoginInfo.textContent = 'เข้าสู่ระบบล่าสุด: '+ fmtTH(last); } } loadFromRepo(); runTests(); })();
</script>
</body>
</html>
